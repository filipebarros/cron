version: 2

jobs:
  build:
    docker:
      - image: circleci/ruby:2.6.3

    steps:
      - checkout # special step to check out source code to working directory
      - restore_cache:
          keys:
            - cron-v1-{{ checksum "Gemfile.lock" }}
            - cron-v1-
      - run:
          name: Install Bundler
          command: gem install bundler -v 2.0.2
      - run:
          name: Bundle Install
          command: bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3
      - save_cache:
          key: cron-v1-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run: mkdir ~/rspec
      - run:
          name: Run Rubocop
          command: bundle exec rubocop
      - run:
          name: Run Tests
          command: bundle exec rspec --format progress --format RspecJunitFormatter -o ~/rspec/rspec.xml
          when: always
      - store_test_results:
          path: ~/rspec
